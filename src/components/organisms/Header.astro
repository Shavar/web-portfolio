---
// Header component - responsive with burger menu using Tailwind CSS
import type { NavigationLink, SocialLink } from '@/types';
import Logo from '@/components/atoms/Logo.astro';
import Icon from '@/components/atoms/Icon.astro';
import styles from '@/data/styles.json';
interface Props {
  links: NavigationLink[];
  socials: SocialLink[];
}

const { links, socials } = Astro.props;
const currentPath = Astro.url.pathname;
---

<header
  id="main-header"
  role="banner"
  class="group fixed left-0 right-0 top-4 z-50 transition-all duration-300"
>
  <div
    class={`${styles.container} hidden md:flex m-auto items-center justify-between rounded-full py-2 transition-all duration-300 group-[.scrolled]:max-w-4xl group-[.scrolled]:bg-navigation group-[.scrolled]:backdrop-blur-xl group-[.scrolled]:shadow-md group-[.scrolled]:border border-border-primary`}
  >
    <!-- Logo/Brand -->
    <a href="/" class="flex w-[100px] items-center gap-2">
      <div
        class="flex h-8 w-8 items-center justify-center rounded-full text-gray-900 dark:text-white"
      >
        <Logo />
      </div>
    </a>

    <!-- Desktop Navigation -->
    <nav class="hidden items-center gap-2 rounded-full p-1 md:flex">
      {
        links.map((link: NavigationLink) => {
          const isActive = currentPath === link.href;

          return (
            <a
              href={link.href}
              class={`hover:bg-quaternary hover:text-tertiary rounded-full px-4 py-1.5 text-sm font-medium transition hover:-translate-y-1 ${isActive ? ' bg-primary text-tertiary' : ' bg-transparent'}`}
              target={link.target}
            >
              {link.label}
            </a>
          );
        })
      }
    </nav>

    <div class="flex w-[100px] items-center justify-end gap-2">
      <div class="flex gap-4 pr-2 pt-1">
        {
          socials.map((social: SocialLink) => {
            return (
              <a
                aria-label={social.label}
                class="hover:text-quaternary transition-colors"
                href={social.href}
                target={social.target}
              >
                <Icon name={social.label} class="h-5 w-5" width="20" height="20" />
              </a>
            );
          })
        }
      </div>
    </div>
  </div>

  <!-- Mobile Logo  -->
  <a href="/" class="fixed left-6 top-5 z-50 md:hidden">
    <div class="text-primary flex h-10 w-10">
      <Logo />
    </div>
  </a>

  <!-- Mobile Menu Button -->
  <button
    id="mobile-menu-btn"
    class="group fixed right-6 top-5 z-50 md:hidden"
    aria-label="Toggle navigation"
    aria-expanded="false"
  >
    <div
      class="bg-primary relative flex h-[45px] w-[45px] transform items-center justify-center overflow-hidden rounded-xl shadow-md ring-0 ring-opacity-30 transition-all duration-200"
    >
      <div
        class="flex h-[20px] w-[20px] origin-center transform flex-col justify-between overflow-hidden transition-all duration-300"
      >
        <div
          class="burger-line-1 bg-tertiary h-[3px] w-7 origin-left transform transition-all duration-300"
        >
        </div>
        <div
          class="burger-line-2 bg-tertiary h-[3px] w-7 transform rounded transition-all delay-75 duration-300"
        >
        </div>
        <div
          class="burger-line-3 bg-tertiary h-[3px] w-7 origin-left transform transition-all delay-150 duration-300"
        >
        </div>

        <div
          class="burger-x absolute left-[11px] top-[22px] flex w-0 -translate-x-12 transform items-center justify-between transition-all duration-500"
        >
          <div
            class="bg-tertiary absolute h-[3px] w-6 rotate-0 transform transition-all delay-300 duration-500"
          >
          </div>
          <div
            class="bg-tertiary absolute h-[3px] w-6 -rotate-0 transform transition-all delay-300 duration-500"
          >
          </div>
        </div>
      </div>
    </div>
  </button>

  <!-- Mobile Navigation Menu -->
  <nav id="mobile-nav" class="fixed left-0 top-0 z-40 hidden h-screen w-full md:hidden">
    <div
      class="bg-navigation flex h-screen w-full flex-col items-center justify-between py-20 backdrop-blur-none transition-all duration-500"
    >
      <div></div>
      <div class="flex flex-col items-center space-y-6">
        {
          links.map((link: NavigationLink, index) => {
            const isActive = currentPath === link.href;

            return (
              <a
                href={link.href}
                class={`hover:bg-quaternary hover:text-tertiary translate-y-4 transform rounded-full px-4 py-1.5 text-2xl font-medium opacity-0 transition-all duration-300 ${isActive ? ' bg-primary text-tertiary' : ' bg-transparent'}`}
                target={link.target}
                style={`transition-delay: ${100 + index * 50}ms;`}
              >
                {link.label}
              </a>
            );
          })
        }
      </div>
      <div
        id="mobile-social-icons"
        class="flex translate-y-4 gap-6 opacity-0 transition-all duration-300"
        style="transition-delay: 300ms;"
      >
        {
          socials.map((social: SocialLink) => {
            return (
              <a
                aria-label={social.label}
                class="hover:text-quaternary text-2xl transition-colors"
                href={social.href}
                target={social.target}
              >
                <Icon name={social.label} class="h-8 w-8" width="32" height="32" />
              </a>
            );
          })
        }
      </div>
    </div>
  </nav>
</header>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileNav = document.getElementById('mobile-nav');
    const header = document.getElementById('main-header');

    // Mobile menu functionality with animations
    mobileMenuBtn?.addEventListener('click', () => {
      const isExpanded = mobileMenuBtn.getAttribute('aria-expanded') === 'true';
      const newState = !isExpanded;

      mobileMenuBtn.setAttribute('aria-expanded', newState.toString());

      // Toggle button animation classes
      const burgerLines = mobileMenuBtn.querySelectorAll(
        '.burger-line-1, .burger-line-2, .burger-line-3'
      );
      const burgerX = mobileMenuBtn.querySelector('.burger-x');

      if (newState) {
        // Show menu with blur animation
        mobileNav?.classList.remove('hidden');

        // Transform burger to X
        burgerLines.forEach((line) => line.classList.add('translate-x-10'));
        burgerX?.classList.remove('w-0', '-translate-x-10');
        burgerX?.classList.add('w-12', 'translate-x-0');
        burgerX?.querySelector('div:first-child')?.classList.add('rotate-45');
        burgerX?.querySelector('div:last-child')?.classList.add('-rotate-45');

        // Trigger animations after a brief delay
        setTimeout(() => {
          const menuContainer = mobileNav?.querySelector('div');
          const menuLinks = mobileNav?.querySelectorAll('a');
          const socialIcons = document.getElementById('mobile-social-icons');

          // Animate background blur
          menuContainer?.classList.remove('backdrop-blur-none');
          menuContainer?.classList.add('backdrop-blur-xl');

          // Animate menu links with staggered effect
          menuLinks?.forEach((link) => {
            link.classList.remove('translate-y-4', 'opacity-0');
            link.classList.add('translate-y-0', 'opacity-100');
          });

          // Animate social icons
          socialIcons?.classList.remove('translate-y-4', 'opacity-0');
          socialIcons?.classList.add('translate-y-0', 'opacity-100');
        }, 10);
      } else {
        // Transform X back to burger
        burgerLines.forEach((line) => line.classList.remove('translate-x-10'));
        burgerX?.classList.remove('w-12', 'translate-x-0');
        burgerX?.classList.add('w-0', '-translate-x-10');
        burgerX?.querySelector('div:first-child')?.classList.remove('rotate-45');
        burgerX?.querySelector('div:last-child')?.classList.remove('-rotate-45');

        // Hide menu with animation
        const menuContainer = mobileNav?.querySelector('div');
        const menuLinks = mobileNav?.querySelectorAll('a');
        const socialIcons = document.getElementById('mobile-social-icons');

        // Animate out background blur
        menuContainer?.classList.remove('backdrop-blur-xl');
        menuContainer?.classList.add('backdrop-blur-none');

        // Animate out menu links
        menuLinks?.forEach((link) => {
          link.classList.remove('translate-y-0', 'opacity-100');
          link.classList.add('translate-y-4', 'opacity-0');
        });

        // Animate out social icons
        socialIcons?.classList.remove('translate-y-0', 'opacity-100');
        socialIcons?.classList.add('translate-y-4', 'opacity-0');

        // Hide after animation completes
        setTimeout(() => {
          mobileNav?.classList.add('hidden');
        }, 500);
      }
    });

    // Helper function to close menu with animation
    const closeMenuWithAnimation = () => {
      const burgerLines = mobileMenuBtn?.querySelectorAll(
        '.burger-line-1, .burger-line-2, .burger-line-3'
      );
      const burgerX = mobileMenuBtn?.querySelector('.burger-x');

      // Transform X back to burger
      burgerLines?.forEach((line) => line.classList.remove('translate-x-10'));
      burgerX?.classList.remove('w-12', 'translate-x-0');
      burgerX?.classList.add('w-0', '-translate-x-10');
      burgerX?.querySelector('div:first-child')?.classList.remove('rotate-45');
      burgerX?.querySelector('div:last-child')?.classList.remove('-rotate-45');

      const menuContainer = mobileNav?.querySelector('div');
      const menuLinks = mobileNav?.querySelectorAll('a');

      // Animate out background blur
      menuContainer?.classList.remove('bg-white/95', 'dark:bg-gray-900/95', 'backdrop-blur-xl');
      menuContainer?.classList.add('bg-white/0', 'dark:bg-gray-900/0', 'backdrop-blur-none');

      menuLinks?.forEach((link) => {
        link.classList.remove('translate-y-0', 'opacity-100');
        link.classList.add('translate-y-4', 'opacity-0');
      });

      setTimeout(() => {
        mobileNav?.classList.add('hidden');
        mobileMenuBtn?.setAttribute('aria-expanded', 'false');
      }, 500);
    };

    // Close menu when clicking nav links
    mobileNav?.addEventListener('click', (e) => {
      if (e.target instanceof HTMLAnchorElement) {
        closeMenuWithAnimation();
      }
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !mobileNav?.classList.contains('hidden')) {
        closeMenuWithAnimation();
      }
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (
        !mobileMenuBtn?.contains(e.target as Node) &&
        !mobileNav?.contains(e.target as Node) &&
        !mobileNav?.classList.contains('hidden')
      ) {
        closeMenuWithAnimation();
      }
    });

    // Scroll-based approach for intro section
    const introSection =
      document.querySelector('section#intro') || document.querySelector('section#hero');

    const heightOffset = introSection?.id == 'hero' ? 500 : 200;

    if (introSection && header) {
      let ticking = false;

      const checkScroll = () => {
        const rect = introSection.getBoundingClientRect();
        const remainingHeight = rect.bottom;

        // If 100px or less of the intro section is visible
        if (remainingHeight <= heightOffset) {
          header.classList.add('scrolled');
        } else {
          header.classList.remove('scrolled');
        }

        ticking = false;
      };

      const onScroll = () => {
        if (!ticking) {
          requestAnimationFrame(checkScroll);
          ticking = true;
        }
      };

      window.addEventListener('scroll', onScroll, { passive: true });

      // Initial check
      checkScroll();
    }
  });
</script>
