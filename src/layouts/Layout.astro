---
import Header from '@/components/organisms/Header.astro';
import Footer from '@/components/organisms/Footer.astro';
import Hero from '@/components/organisms/Hero.astro';
import type { ImageMetadata } from 'astro';
import globalData from '@/data/global.json';
import '@/styles/variables.css';
import '@/styles/fonts.css';

interface Props {
  title: string;
  description: string;
  heroImage?: ImageMetadata;
  heroLayout?: 'standard' | 'hero';
  showHeader?: boolean;
  showFooter?: boolean;
  showIntro?: boolean;
  hasHero?: boolean;
}

const {
  title,
  description,
  showHeader = true,
  showFooter = true,
  showIntro = true,
  hasHero = false,
  heroImage,
  heroLayout = 'standard',
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Performance optimizations -->
    <meta name="robots" content="index, follow" />
    <meta name="googlebot" content="index, follow" />
    <meta name="theme-color" content="#1a1a1a" />
    <meta name="color-scheme" content="light dark" />

    <!-- Resource hints for better performance -->
    <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title === 'Shavar Cox' ? title : title + ' | Shavar Cox'}</title>

    <!-- Preload critical local fonts for optimal performance -->
    <link rel="preload" href="/fonts/poppins-400.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/poppins-600.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/poppins-700.woff2" as="font" type="font/woff2" crossorigin />

    <!-- Open Graph tags for social sharing -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />

    <!-- Twitter Card tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
  </head>
  <body
    class="bg-tertiary font-body text-primary duration-normal reduced-motion focus-ring leading-relaxed antialiased transition-colors"
  >
    <!-- Google Tag Manager (noscript) -->
    <noscript>
      <iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-M2LNZR54"
        height="0"
        width="0"
        style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Skip to main content for screen readers -->
    <a
      href="#main-content"
      class="sr-only focus:not-sr-only focus:absolute focus:left-6 focus:top-6 focus:z-[60] focus:rounded focus:bg-white focus:px-4 focus:py-2 focus:text-black focus:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      Skip to main content
    </a>
    {showHeader && <Header links={globalData.header} socials={globalData.socials} />}

    <main
      id="main-content"
      role="main"
      class:list={showIntro ? ['min-h-screen', { 'mt-18 md:mt-28': !hasHero }] : []}
    >
      {
        showIntro && (
          <Hero
            heading={title}
            description={description}
            heroLayout={heroLayout}
            heroImage={heroImage}
          />
        )
      }
      <slot />
    </main>

    {showFooter && <Footer copyright={globalData.footer.copyright} socials={globalData.socials} />}

    <!-- Google Tag Manager - Deferred for Performance (loads on user interaction) -->
    <script is:inline>
      // Defer GTM loading until user interaction for optimal performance
      let gtmLoaded = false;

      function loadGTM() {
        if (gtmLoaded) return;
        gtmLoaded = true;

        (function (w, d, s, l, i) {
          w[l] = w[l] || [];
          w[l].push({ 'gtm.start': new Date().getTime(), event: 'gtm.js' });
          var f = d.getElementsByTagName(s)[0],
            j = d.createElement(s),
            dl = l != 'dataLayer' ? '&l=' + l : '';
          j.async = true;
          j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
          f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-M2LNZR54');
      }

      // Load GTM on first user interaction or after 3 seconds (whichever comes first)
      const events = ['scroll', 'click', 'touchstart', 'mousemove', 'keydown'];
      const loadOnInteraction = () => {
        events.forEach((event) => document.removeEventListener(event, loadOnInteraction));
        loadGTM();
      };

      events.forEach((event) =>
        document.addEventListener(event, loadOnInteraction, { once: true, passive: true })
      );

      // Fallback: load after 3 seconds if no interaction
      setTimeout(loadGTM, 3000);
    </script>

    <!-- GTM Custom Event Tracking -->
    <script is:inline>
      // Helper function to push events to dataLayer
      function pushGTMEvent(eventName, eventData = {}) {
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: eventName,
          ...eventData,
        });
      }

      // Wait for DOM to be ready
      document.addEventListener('DOMContentLoaded', function () {
        // Track navigation clicks (desktop and mobile)
        document.querySelectorAll('nav a, #mobile-nav a').forEach(function (link) {
          link.addEventListener('click', function (e) {
            const linkText = this.textContent.trim();
            const linkUrl = this.getAttribute('href');
            const isMobile = this.closest('#mobile-nav') !== null;

            pushGTMEvent('navigation_click', {
              link_text: linkText,
              link_url: linkUrl,
              navigation_type: isMobile ? 'mobile' : 'desktop',
            });
          });
        });

        // Track social media clicks
        document
          .querySelectorAll('a[aria-label*="LinkedIn"], a[aria-label*="GitHub"]')
          .forEach(function (link) {
            link.addEventListener('click', function (e) {
              const platform = this.getAttribute('aria-label');
              const location = this.closest('header')
                ? 'header'
                : this.closest('footer')
                  ? 'footer'
                  : this.closest('#mobile-nav')
                    ? 'mobile_menu'
                    : 'unknown';

              pushGTMEvent('social_click', {
                social_platform: platform,
                location: location,
                link_url: this.href,
              });
            });
          });

        // Track button clicks
        document.querySelectorAll('a[class*="inline-flex"]').forEach(function (button) {
          button.addEventListener('click', function (e) {
            const buttonText = this.textContent.trim();
            const buttonUrl = this.getAttribute('href');

            pushGTMEvent('button_click', {
              button_text: buttonText,
              button_url: buttonUrl,
            });
          });
        });

        // Track external link clicks
        document.querySelectorAll('a[target="_blank"]').forEach(function (link) {
          link.addEventListener('click', function () {
            const linkText = this.textContent.trim();
            const linkUrl = this.href;

            pushGTMEvent('external_link_click', {
              link_text: linkText,
              link_url: linkUrl,
            });
          });
        });

        // Track mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        if (mobileMenuBtn) {
          mobileMenuBtn.addEventListener('click', function () {
            const isExpanded = this.getAttribute('aria-expanded') === 'true';

            pushGTMEvent('mobile_menu_toggle', {
              action: isExpanded ? 'close' : 'open',
            });
          });
        }

        // Track scroll depth (25%, 50%, 75%, 100%)
        let scrollMarks = { 25: false, 50: false, 75: false, 100: false };
        let scrollTimeout;
        window.addEventListener(
          'scroll',
          function () {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(function () {
              const scrollPercent = Math.round(
                (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) *
                  100
              );

              [25, 50, 75, 100].forEach(function (mark) {
                if (scrollPercent >= mark && !scrollMarks[mark]) {
                  scrollMarks[mark] = true;
                  pushGTMEvent('scroll_depth', {
                    scroll_percentage: mark,
                  });
                }
              });
            }, 100);
          },
          { passive: true }
        );
      });
    </script>
  </body>
</html>
